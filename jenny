#!/usr/bin/env groovy

@Grab('org.yaml:snakeyaml:1.17')

// -------------------------------------------------------------------
// Parse the CLI options.
// -------------------------------------------------------------------
def cli = new CliBuilder(usage: "jenny [options]")
cli.f(longOpt: "file", args: 1, argName: "file", "path to Jenkinsfile")
cli.l(longOpt: "lib", args: -2, argName: "lib", "path to the library to load")
cli.p(longOpt: "param", args: -2, argName: "property=value", valueSeparator:'=', "parameter to override")
cli.s(longOpt: "skip", args: -2, argName: "id", "stage/parallel/node blocks to skip by ID")
cli.o(longOpt: "only", args: -2, argName: "id", "stage/parallel/node blocks to run by ID (includes ancestors)")
cli.rf(longOpt: "resumeFrom", args: 1, argName: "id", "stage/parallel/node blocks to continue from")
cli.sa(longOpt: "skipAfter", args: 1, argName: "id", "stage/parallel/node blocks to skiped when reached (inclusive)")
cli.i(longOpt: "info", "show information on the current jenkinsfile, including ids")
cli.h(longOpt: "help", "show this message")

def options = cli.parse(args)

if (options.h) {
    cli.usage();
    return;
}

// -------------------------------------------------------------------
// Start the execution.
// -------------------------------------------------------------------
print """>    _
>   (_) ___ _ __  _ __  _   _
>   | |/ _ \\ '_ \\| '_ \\| | | |
>   | |  __/ | | | | | | |_| |
>  _/ |\\___|_| |_|_| |_|\\__, |
> |__/                  |___/
> console jenkins runner
> 
"""
// find where jenny is installed
File scriptFile = new File(getClass().protectionDomain.codeSource.location.path)

// -------------------------------------------------------------------
// Load the core libraries (config, lib loading)
// -------------------------------------------------------------------
new File(scriptFile.parent, "lib").listFiles().each {
    evaluate(it)
}

loadConfigFile("${System.getenv('HOME')}/.jenny")
loadConfigFile(".jenny/config")
loadCommandLineOptions(options)

// -------------------------------------------------------------------
// Prepare the execution context.
// -------------------------------------------------------------------
def binding = new Binding()
binding._global = binding
binding._jennyConfig = jennyConfig

def shell = new GroovyShell(binding)

// -------------------------------------------------------------------
// Create the workspace
// -------------------------------------------------------------------
// FIXME: generate the workspace per project
def workspaceLocation = new File("/tmp/.jenny/workspace/")
workspaceLocation.deleteDir()
workspaceLocation.mkdir()
binding._workspaceFolder = workspaceLocation
binding._projectFolder = new File(".")

// -------------------------------------------------------------------
// Load the default suport functions
// -------------------------------------------------------------------
// jenny can run in two modes:
// 1. is to actually execute things,
// 2. is to just provide information to the user 
//    on what will be executed, and provide the IDs

// load all the support files.
new File(scriptFile.parent, "common").listFiles().each {
  shell.evaluate(it)
}

new File(scriptFile.parent, options.info ? "info" : "support").listFiles().each {
  shell.evaluate(it)
}

// -------------------------------------------------------------------
// Load the external libraries
// -------------------------------------------------------------------
if (options.info) {
    loadInfoLibraries(shell, binding)
} else {
    loadLibraries(shell, binding)
}

// -------------------------------------------------------------------
// Override parameters
// -------------------------------------------------------------------
if (jennyConfig.params) {
    binding._definedParameters.addNested(jennyConfig.params)
}

// this will run the current jenkinsfile
def jenkinsfile = new File(options.file ?: "Jenkinsfile")
shell.evaluate(jenkinsfile)
